import React, { useState, useEffect, useCallback, useRef } from 'react';
import { ReportCategory, GeolocationState, Transaction, ParkingZone, NewsItem, NewsStatus, NewsType, Report, Landmark } from './types';
import { api } from './services/api';
import { useTranslation } from './i18n';
import { Camera, CameraResultType, CameraSource } from '@capacitor/camera';
import { App as CapacitorApp } from '@capacitor/app';
import { supabase } from './supabase';
import { MapContainer, TileLayer, Marker, Popup, useMap } from 'react-leaflet';
import L from 'leaflet';
import { Icon, Icons, Card, Button, Input, Select } from './components/ui';

// Destructure for easier usage in component, or just use api.method
const { getParkingZones, payParking: payForParking, getEvents, getNews, getLandmarks } = api;

// --- App Component ---
export const App: React.FC = () => {
    const { t, language, setLanguage } = useTranslation();
    const [activeView, setActiveView] = useState(() => localStorage.getItem('lastActiveView') || 'dashboard');
    const [theme, setTheme] = useState<'light' | 'dark'>('light');

    // Lifted photos state for camera restoration
    const [photos, setPhotos] = useState<string[]>(() => {
        const stored = localStorage.getItem('reportPhotos');
        return stored ? JSON.parse(stored) : [];
    });

    useEffect(() => {
        localStorage.setItem('reportPhotos', JSON.stringify(photos));
    }, [photos]);

    useEffect(() => {
        localStorage.setItem('lastActiveView', activeView);
    }, [activeView]);
    const [isVerified, setIsVerified] = useState(false);
    const [phoneNumber, setPhoneNumber] = useState('');
    const [verificationCode, setVerificationCode] = useState('');
    const [showVerificationInput, setShowVerificationInput] = useState(false);
    const [walletBalance, setWalletBalance] = useState(1250);

    // Initialize theme with system preference
    useEffect(() => {
        const savedTheme = localStorage.getItem('theme') as 'light' | 'dark' | null;
        if (savedTheme) {
            setTheme(savedTheme);
        } else {
            // Detect system theme
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            setTheme(prefersDark ? 'dark' : 'light');
        }
    }, []);

    // Apply theme changes
    useEffect(() => {
        if (theme === 'dark') {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
        localStorage.setItem('theme', theme);
    }, [theme]);

    // Check verification
    useEffect(() => {
        const verified = localStorage.getItem('isVerified') === 'true';
        if (verified) setIsVerified(true);
    }, []);

    // Handle Android back button and App Restoration (Camera)
    useEffect(() => {
        let backButtonListener: any;
        let restoreListener: any;

        const setupListeners = async () => {
            backButtonListener = await CapacitorApp.addListener('backButton', ({ canGoBack }) => {
                if (activeView !== 'dashboard') {
                    setActiveView('dashboard');
                } else if (canGoBack) {
                    window.history.back();
                } else {
                    CapacitorApp.exitApp();
                }
            });

            // Handle camera result when app is restored after being killed
            restoreListener = await CapacitorApp.addListener('appRestoredResult', (data: any) => {
                if (data.pluginId === 'Camera' && data.methodName === 'getPhoto' && data.success) {
                    const imagePath = data.data.webPath;
                    if (imagePath) {
                        // Fetch and save the restored photo
                        fetch(imagePath)
                            .then(res => res.blob())
                            .then(blob => {
                                const reader = new FileReader();
                                reader.onloadend = () => {
                                    if (typeof reader.result === 'string') {
                                        // Update state directly
                                        setPhotos(prev => [...prev, reader.result as string]);
                                        // Navigate to report view to show the photo
                                        setActiveView('report');
                                    }
                                };
                                reader.readAsDataURL(blob);
                            })
                            .catch(err => console.error('Error recovering photo:', err));
                    }
                }
            });
        };

        setupListeners();

        return () => {
            if (backButtonListener) backButtonListener.remove();
            if (restoreListener) restoreListener.remove();
        };
    }, [activeView]);

    const handleVerify = async () => {
        try {
            // Format phone number the same way as when sending the code
            const formattedPhone = phoneNumber.startsWith('+') ? phoneNumber : `+389${phoneNumber}`;

            const { data, error } = await supabase.auth.verifyOtp({
                phone: formattedPhone,
                token: verificationCode,
                type: 'sms'
            });

            if (error) {
                alert(t('error_code_mismatch'));
                console.error('Verification error:', error);
            } else {
                localStorage.setItem('isVerified', 'true');
                setIsVerified(true);
            }
        } catch (err) {
            alert(t('error_code_mismatch'));
            console.error('Verification error:', err);
        }
    };

    const renderContent = () => {
        switch (activeView) {
            case 'dashboard': return <HomeView onViewChange={setActiveView} walletBalance={walletBalance} />;
            case 'report': return <ReportView onViewChange={setActiveView} photos={photos} setPhotos={setPhotos} />;
            case 'parking': return <ParkingView walletBalance={walletBalance} setWalletBalance={setWalletBalance} />;
            case 'events': return <EventsView />;
            case 'news': return <NewsView />;
            case 'wallet': return <WalletView balance={walletBalance} setBalance={setWalletBalance} />;
            case 'map': return <MapView />;
            case 'history': return <HistoryView />;
            case 'menu': return <MenuHub onViewChange={setActiveView} theme={theme} setTheme={setTheme} language={language} setLanguage={setLanguage} />;
            default: return <HomeView onViewChange={setActiveView} walletBalance={walletBalance} />;
        }
    };

    const handleSendCode = async () => {
        if (phoneNumber.length < 8) {
            alert(t('error_phone_invalid'));
            return;
        }

        try {
            // Format phone number with country code (assuming Macedonia +389)
            const formattedPhone = phoneNumber.startsWith('+') ? phoneNumber : `+389${phoneNumber}`;

            const { data, error } = await supabase.auth.signInWithOtp({
                phone: formattedPhone
            });

            if (error) {
                alert(`Error: ${error.message}`);
                console.error('Send OTP error:', error);
            } else {
                setShowVerificationInput(true);
                alert(t('code_sent'));
            }
        } catch (err) {
            alert(`Error sending code: ${err}`);
            console.error('Send OTP error:', err);
        }
    };

    if (!isVerified) {
        return (
            <div className="min-h-screen flex items-center justify-center p-6 bg-slate-50 dark:bg-slate-950">
                <Card className="w-full max-w-sm p-8 text-center">
                    <div className="w-16 h-16 bg-indigo-100 dark:bg-indigo-900/30 rounded-full flex items-center justify-center mx-auto mb-6">
                        <Icon path={Icons.phone} className="text-indigo-600" size={32} />
                    </div>
                    <h1 className="text-2xl font-bold text-slate-900 dark:text-white mb-2">{t('verify_account')}</h1>
                    <p className="text-slate-500 mb-8">{t('verification_description')}</p>

                    {!showVerificationInput ? (
                        <div className="space-y-4">
                            <Input
                                type="tel"
                                placeholder={t('phone_placeholder')}
                                value={phoneNumber}
                                onChange={(e) => setPhoneNumber(e.target.value)}
                            />
                            <Button fullWidth onClick={handleSendCode}>
                                {t('send_code')}
                            </Button>
                        </div>
                    ) : (
                        <div className="space-y-4">
                            <p className="text-sm text-slate-500">{t('enter_code_prompt')} <span className="font-semibold text-slate-900 dark:text-white">{phoneNumber}</span></p>
                            <Input
                                type="text"
                                placeholder="123456"
                                value={verificationCode}
                                onChange={(e) => setVerificationCode(e.target.value)}
                                className="text-center tracking-widest text-xl font-mono"
                            />
                            <Button fullWidth onClick={handleVerify}>{t('verify')}</Button>
                            <Button variant="ghost" fullWidth onClick={() => setShowVerificationInput(false)}>{t('change_number')}</Button>
                        </div>
                    )}
                </Card>
            </div>
        );
    }

    return (
        <div className="relative min-h-screen bg-slate-50 dark:bg-slate-950 max-w-md mx-auto shadow-2xl overflow-hidden">
            {/* Header with Safe Area Support */}
            <div
                className="absolute top-0 left-0 right-0 px-6 flex items-center justify-between z-20 bg-white/80 dark:bg-slate-900/80 backdrop-blur-md border-b border-slate-200/50 dark:border-slate-800/50"
                style={{ paddingTop: 'max(16px, env(safe-area-inset-top))', height: 'calc(64px + env(safe-area-inset-top))' }}
            >
                <div className="flex items-center gap-2" onClick={() => setActiveView('dashboard')}>
                    <div className="w-8 h-8 bg-indigo-600 rounded-lg flex items-center justify-center">
                        <Icon path={Icons.building} className="text-white" size={18} />
                    </div>
                    <span className="font-bold text-lg text-slate-900 dark:text-white tracking-tight">{t('app_title')}</span>
                </div>
                <div className="flex items-center gap-3">
                    <button onClick={() => setActiveView('wallet')} className="flex items-center gap-2 px-3 py-1.5 bg-slate-100 dark:bg-slate-800 rounded-full">
                        <Icon path={Icons.wallet} size={14} className="text-indigo-600" />
                        <span className="text-sm font-semibold text-slate-700 dark:text-slate-200">{walletBalance}</span>
                    </button>
                </div>
            </div>

            {/* Scrollable Content with Padding for Header and Nav */}
            <main
                className="absolute left-0 right-0 overflow-y-auto no-scrollbar p-4"
                style={{
                    top: 'calc(64px + env(safe-area-inset-top))',
                    bottom: 'calc(80px + env(safe-area-inset-bottom))'
                }}
            >
                <div className="animate-fade-in">
                    {renderContent()}
                </div>
            </main>

            {/* Bottom Navigation with Safe Area Support */}
            <div
                className="absolute bottom-0 left-0 right-0 bg-white/90 dark:bg-slate-900/90 backdrop-blur-xl border-t border-slate-200 dark:border-slate-800 px-6 flex items-center justify-between z-30"
                style={{
                    paddingBottom: 'env(safe-area-inset-bottom)',
                    height: 'calc(80px + env(safe-area-inset-bottom))'
                }}
            >
                <NavButton icon={Icons.home} label="Home" active={activeView === 'dashboard'} onClick={() => setActiveView('dashboard')} />
                <NavButton icon={Icons.parking} label="Parking" active={activeView === 'parking'} onClick={() => setActiveView('parking')} />

                {/* FAB */}
                <div className="-mt-8">
                    <button
                        onClick={() => setActiveView('report')}
                        className="w-14 h-14 bg-indigo-600 rounded-full shadow-lg shadow-indigo-600/30 flex items-center justify-center text-white active:scale-95 transition-transform"
                    >
                        <Icon path={Icons.plus} size={28} />
                    </button>
                </div>

                <NavButton icon={Icons.wallet} label="Wallet" active={activeView === 'wallet'} onClick={() => setActiveView('wallet')} />
                <NavButton icon={Icons.menu} label="Menu" active={activeView === 'menu'} onClick={() => setActiveView('menu')} />
            </div>
        </div>
    );
};

const NavButton: React.FC<{ icon: string; label: string; active: boolean; onClick: () => void }> = ({ icon, label, active, onClick }) => (
    <button onClick={onClick} className={`flex flex-col items-center gap-1 ${active ? 'text-indigo-600' : 'text-slate-400 hover:text-slate-600 dark:hover:text-slate-300'}`}>
        <Icon path={icon} size={24} strokeWidth={active ? 2.5 : 1.5} />
        {/* <span className="text-[10px] font-medium">{label}</span> */}
    </button>
);

// --- Sub-Views ---

const MapView: React.FC = () => {
    const { t, language } = useTranslation();
    const [landmarks, setLandmarks] = useState<Landmark[]>([]);
    const [selectedLandmark, setSelectedLandmark] = useState<Landmark | null>(null);
    const [loading, setLoading] = useState(true);

    useEffect(() => {
        getLandmarks().then(data => {
            setLandmarks(data);
            setLoading(false);
        }).catch(err => {
            console.error('Failed to fetch landmarks:', err);
            setLoading(false);
        });
    }, []);

    const openNativeMap = (lat: number, lng: number, name: string) => {
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
        const url = isIOS
            ? `maps://maps.apple.com/?daddr=${lat},${lng}`
            : `geo:${lat},${lng}?q=${lat},${lng}(${encodeURIComponent(name)})`;
        window.location.href = url;
    };

    const getTitle = (landmark: Landmark) => {
        const key = `title_${language}` as keyof Landmark;
        return landmark[key] as string || landmark.title_en || landmark.title;
    };

    const getDescription = (landmark: Landmark) => {
        const key = `description_${language}` as keyof Landmark;
        return landmark[key] as string || landmark.description_en || landmark.description;
    };

    if (loading) {
        return (
            <div className="h-full flex items-center justify-center">
                <p className="text-slate-500">{t('loading')}</p>
            </div>
        );
    }

    return (
        <>
            <div className="relative h-full pb-20">
                <h2 className="text-2xl font-bold text-slate-900 dark:text-white mb-4">
                    {t('map_view')}
                </h2>

                <div className="rounded-3xl overflow-hidden shadow-lg" style={{ height: 'calc(100vh - 200px)' }}>
                    <MapContainer
                        center={[41.5128, 20.9574]}
                        zoom={13}
                        style={{ height: '100%', width: '100%' }}
                    >
                        <TileLayer
                            url="https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"
                            attribution='&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
                        />

                        {landmarks.map((landmark) => (
                            <Marker
                                key={landmark.id}
                                position={[landmark.latitude, landmark.longitude]}
                                eventHandlers={{
                                    click: () => setSelectedLandmark(landmark)
                                }}
                            >
                                <Popup>
                                    <div className="text-center">
                                        <strong>{getTitle(landmark)}</strong>
                                        <br />
                                        <span className="text-xs text-slate-500">{landmark.category}</span>
                                    </div>
                                </Popup>
                            </Marker>
                        ))}
                    </MapContainer>
                </div>
            </div>

            {selectedLandmark && (
                <div className="fixed inset-0 bg-black/90 z-50 flex flex-col">
                    <div className="flex items-center justify-between p-4 text-white">
                        <span className="text-sm capitalize">{selectedLandmark.category}</span>
                        <button
                            onClick={() => setSelectedLandmark(null)}
                            className="p-2 hover:bg-white/10 rounded-full transition-colors"
                        >
                            <Icon path={Icons.x} size={24} />
                        </button>
                    </div>

                    {selectedLandmark.photo_url && (
                        <div className="flex-1 flex items-center justify-center p-4">
                            <img
                                src={selectedLandmark.photo_url}
                                alt={getTitle(selectedLandmark)}
                                className="max-w-full max-h-full object-contain rounded-2xl"
                            />
                        </div>
                    )}

                    <div className="bg-white dark:bg-slate-900 p-6 rounded-t-3xl">
                        <div className="flex items-center gap-2 mb-3">
                            <span className="px-3 py-1 rounded-full text-xs font-bold uppercase bg-indigo-100 dark:bg-indigo-900/30 text-indigo-700 dark:text-indigo-400">
                                {selectedLandmark.category}
                            </span>
                        </div>
                        <h2 className="text-xl font-bold text-slate-900 dark:text-white mb-3">
                            {getTitle(selectedLandmark)}
                        </h2>
                        <p className="text-slate-600 dark:text-slate-400 leading-relaxed mb-6">
                            {getDescription(selectedLandmark)}
                        </p>

                        <Button
                            variant="primary"
                            fullWidth
                            onClick={() => openNativeMap(
                                selectedLandmark.latitude,
                                selectedLandmark.longitude,
                                getTitle(selectedLandmark)
                            )}
                            className="gap-2"
                        >
                            <Icon path={Icons.location} size={20} />
                            {t('get_directions')}
                        </Button>
                    </div>
                </div>
            )}
        </>
    );
};

const HomeView: React.FC<{ onViewChange: (view: string) => void, walletBalance: number }> = ({ onViewChange, walletBalance }) => {
    const { t } = useTranslation();
    const hour = new Date().getHours();
    const greeting = hour < 12 ? t('good_morning') : hour < 18 ? t('good_afternoon') : t('good_evening');

    return (
        <div className="space-y-6">
            {/* Greeting */}
            <div>
                <h2 className="text-3xl font-bold text-slate-900 dark:text-white">{greeting}, Citizen</h2>
                <p className="text-slate-500">{t('how_can_we_help')}</p>
            </div>

            {/* Quick Actions Grid */}
            <div className="grid grid-cols-2 gap-4">
                <ServiceCard icon={Icons.report} title={t('report_new_issue')} color="bg-rose-500" onClick={() => onViewChange('report')} />
                <ServiceCard icon={Icons.parking} title={t('parking')} color="bg-indigo-500" onClick={() => onViewChange('parking')} />
                <ServiceCard icon={Icons.calendarDays} title={t('events')} color="bg-orange-500" onClick={() => onViewChange('events')} />
                <ServiceCard icon={Icons.news} title={t('news')} color="bg-emerald-500" onClick={() => onViewChange('news')} />
                <ServiceCard icon={Icons.map} title={t('map_view')} color="bg-cyan-500" onClick={() => onViewChange('map')} />
                <ServiceCard icon={Icons.history} title={t('report_history')} color="bg-slate-500" onClick={() => onViewChange('history')} />
            </div>

            {/* Mini Wallet Widget */}
            <Card className="p-5 bg-gradient-to-br from-indigo-600 to-purple-700 border-none text-white" onClick={() => onViewChange('wallet')}>
                <div className="flex justify-between items-start">
                    <div>
                        <p className="text-indigo-100 text-sm font-medium">{t('current_balance')}</p>
                        <h3 className="text-3xl font-bold mt-1">{walletBalance} <span className="text-lg font-normal opacity-80">MKD</span></h3>
                    </div>
                    <div className="p-2 bg-white/10 rounded-xl backdrop-blur-sm">
                        <Icon path={Icons.wallet} className="text-white" />
                    </div>
                </div>
            </Card>
        </div>
    );
};

const ServiceCard: React.FC<{ icon: string; title: string; color: string; onClick: () => void }> = ({ icon, title, color, onClick }) => (
    <button onClick={onClick} className="bg-white dark:bg-slate-900 p-4 rounded-3xl shadow-sm border border-slate-100 dark:border-slate-800 flex flex-col items-start gap-3 hover:scale-[1.02] active:scale-[0.98] transition-all text-left group">
        <div className={`w-10 h-10 ${color} rounded-2xl flex items-center justify-center text-white shadow-md`}>
            <Icon path={icon} size={20} />
        </div>
        <span className="font-semibold text-slate-900 dark:text-white text-sm leading-tight group-hover:text-indigo-600 dark:group-hover:text-indigo-400 transition-colors">{title}</span>
    </button>
);

const ReportView: React.FC<{ onViewChange: (view: string) => void, photos: string[], setPhotos: React.Dispatch<React.SetStateAction<string[]>> }> = ({ onViewChange, photos, setPhotos }) => {
    const { t } = useTranslation();
    // Photos state lifted to App component
    const [location, setLocation] = useState<GeolocationState | null>(null);
    const [description, setDescription] = useState(() => localStorage.getItem('reportDescription') || '');
    const [analyzing, setAnalyzing] = useState(false);

    useEffect(() => {
        localStorage.setItem('reportDescription', description);
    }, [description]);

    // Persist photos to localStorage whenever they change - handled in App component now
    // But we keep this for consistency if needed, though App handles it.
    // Actually, App handles it, so we can remove it here to avoid double writes.

    const [aiResult, setAiResult] = useState<{ title: string; category: ReportCategory } | null>(null);
    const [showSuccess, setShowSuccess] = useState(false);
    const [showPhotoOptions, setShowPhotoOptions] = useState(false);

    useEffect(() => {
        // Test Railway connectivity
        api.testHealth().then(() => {
            console.log('Railway backend is reachable!');
        }).catch(err => {
            console.error('Railway backend is NOT reachable:', err);
        });

        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                (pos) => setLocation({ latitude: pos.coords.latitude, longitude: pos.coords.longitude }),
                (err) => {
                    console.error("Location access denied", err);
                },
                { timeout: 10000, enableHighAccuracy: true }
            );
        }
    }, []);

    const handleTakePhoto = async (source: CameraSource) => {
        try {
            const image = await Camera.getPhoto({
                quality: 50,
                width: 1024,
                height: 1024,
                allowEditing: false,
                resultType: CameraResultType.Uri, // Changed to Uri for better stability
                source: source,
                saveToGallery: false
            });

            if (image.webPath) {
                // Convert blob/url to base64 for display/upload
                const response = await fetch(image.webPath);
                const blob = await response.blob();
                const reader = new FileReader();
                reader.onloadend = () => {
                    if (typeof reader.result === 'string') {
                        // Update state
                        setPhotos(prev => [...prev, reader.result as string]);
                        setShowPhotoOptions(false); // Close modal only after photo is added
                    }
                };
                reader.readAsDataURL(blob);
            }
        } catch (error) {
            console.error('Error taking photo:', error);
            setShowPhotoOptions(false); // Close modal on error
        }
    };

    const removePhoto = (index: number) => {
        setPhotos(photos.filter((_, i) => i !== index));
    };

    const handleSubmit = async () => {
        if (photos.length === 0 || !location) return alert(t('error_required_fields'));

        setAnalyzing(true);
        try {
            // Get the authenticated user's ID from Supabase
            const { data: { user } } = await supabase.auth.getUser();
            if (!user) {
                alert('Please log in to submit a report');
                setAnalyzing(false);
                return;
            }

            const formData = new FormData();

            // Append all photos
            for (let i = 0; i < photos.length; i++) {
                const response = await fetch(photos[i]);
                const blob = await response.blob();
                const file = new File([blob], `photo_${i}.jpg`, { type: 'image/jpeg' });
                formData.append('photos', file);
            }

            formData.append('user_id', user.id); // Use authenticated user's ID
            formData.append('lat', location.latitude.toString());
            formData.append('lng', location.longitude.toString());
            formData.append('description', description);

            const report = await api.submitReport(formData);

            const newReport: Report = {
                id: report.id,
                title: report.title,
                category: report.category as ReportCategory,
                location,
                photoPreviewUrl: photos[0] || '',
                timestamp: report.created_at
            };

            const existing = localStorage.getItem('submittedReports');
            const reports = existing ? JSON.parse(existing) : [];
            localStorage.setItem('submittedReports', JSON.stringify([newReport, ...reports]));

            // Clear photos and description after successful submission
            setPhotos([]);
            setDescription('');
            localStorage.removeItem('reportPhotos');
            localStorage.removeItem('reportDescription');
            setAiResult({ title: report.title, category: report.category as ReportCategory });
            setShowSuccess(true);
        } catch (e) {
            alert('Failed to submit report: ' + e);
            console.error(e);
        } finally {
            setAnalyzing(false);
        }
    };

    if (showSuccess) {
        return (
            <div className="h-full flex flex-col items-center justify-center text-center p-6">
                <div className="w-20 h-20 bg-green-100 dark:bg-green-900/30 text-green-600 rounded-full flex items-center justify-center mb-6 animate-slide-up">
                    <Icon path={Icons.checkCircle} size={40} />
                </div>
                <h2 className="text-2xl font-bold text-slate-900 dark:text-white mb-2">{t('report_submitted')}</h2>
                <p className="text-slate-500 mb-8">{t('report_submitted_desc')}</p>
                <Button onClick={() => onViewChange('dashboard')}>{t('back_to_dashboard')}</Button>
            </div>
        );
    }

    return (
        <div className="space-y-6 pb-20">
            <h2 className="text-2xl font-bold text-slate-900 dark:text-white">{t('submit_new_report')}</h2>

            {/* Photo Upload */}
            <div className="space-y-4">
                {photos.length > 0 ? (
                    <div className="flex gap-4 overflow-x-auto pb-2 no-scrollbar">
                        {photos.map((p, index) => (
                            <div key={index} className="relative flex-shrink-0 w-40 h-40 rounded-xl overflow-hidden group">
                                <img src={p} alt={`Photo ${index + 1}`} className="w-full h-full object-cover" />
                                <button
                                    onClick={() => removePhoto(index)}
                                    className="absolute top-2 right-2 bg-red-500 text-white p-1 rounded-full opacity-0 group-hover:opacity-100 transition-opacity"
                                >
                                    <Icon path={Icons.x} size={16} />
                                </button>
                            </div>
                        ))}
                        {photos.length < 5 && (
                            <button
                                onClick={() => setShowPhotoOptions(true)}
                                className="flex-shrink-0 w-40 h-40 rounded-xl border-2 border-dashed border-slate-300 dark:border-slate-700 flex flex-col items-center justify-center text-slate-400 hover:border-indigo-500 hover:text-indigo-500 transition-colors"
                            >
                                <Icon path={Icons.plus} size={32} />
                                <span className="text-xs mt-2">{t('add_photo')}</span>
                            </button>
                        )}
                    </div>
                ) : (
                    <div
                        onClick={() => setShowPhotoOptions(true)}
                        className="relative aspect-video rounded-3xl border-2 border-dashed border-slate-300 dark:border-slate-700 flex flex-col items-center justify-center cursor-pointer overflow-hidden transition-all hover:border-indigo-400 bg-slate-50 dark:bg-slate-800"
                    >
                        <div className="flex flex-col items-center gap-3 text-slate-400">
                            <div className="w-16 h-16 rounded-full bg-slate-200 dark:bg-slate-700 flex items-center justify-center">
                                <Icon path={Icons.camera} size={32} />
                            </div>
                            <p className="font-medium">{t('tap_to_take_photo')}</p>
                        </div>
                    </div>
                )}
            </div>

            {/* Photo Options Modal */}
            {showPhotoOptions && (
                <div className="fixed inset-0 z-50 flex items-end justify-center bg-black/50" onClick={() => setShowPhotoOptions(false)}>
                    <div className="bg-white dark:bg-slate-900 rounded-t-3xl w-full max-w-md p-6 space-y-3" onClick={(e) => e.stopPropagation()}>
                        <h3 className="text-lg font-bold text-slate-900 dark:text-white mb-4">{t('add_photo')}</h3>
                        <Button fullWidth variant="secondary" onClick={() => handleTakePhoto(CameraSource.Camera)}>
                            <Icon path={Icons.camera} size={20} />
                            {t('take_photo')}
                        </Button>
                        <Button fullWidth variant="secondary" onClick={() => handleTakePhoto(CameraSource.Photos)}>
                            <Icon path={Icons.news} size={20} />
                            {t('choose_from_gallery')}
                        </Button>
                        <Button fullWidth variant="ghost" onClick={() => setShowPhotoOptions(false)}>
                            {t('cancel')}
                        </Button>
                    </div>
                </div>
            )}

            {/* Location Status */}
            <div className={`flex items-center gap-3 p-3 rounded-2xl border ${location ? 'bg-emerald-50 border-emerald-100 dark:bg-emerald-900/20 dark:border-emerald-900/50' : 'bg-amber-50 border-amber-100 dark:bg-amber-900/20 dark:border-amber-900/50'}`}>
                <div className={`w-8 h-8 rounded-full flex items-center justify-center ${location ? 'bg-emerald-100 text-emerald-600 dark:bg-emerald-900/50 dark:text-emerald-400' : 'bg-amber-100 text-amber-600 dark:bg-amber-900/50 dark:text-amber-400'}`}>
                    <Icon path={Icons.location} size={16} className={!location ? 'animate-pulse' : ''} />
                </div>
                <div>
                    <p className={`text-sm font-semibold ${location ? 'text-emerald-900 dark:text-emerald-100' : 'text-amber-900 dark:text-amber-100'}`}>
                        {location ? t('location_acquired') : t('fetching_location')}
                    </p>
                    <p className="text-xs opacity-70 dark:text-slate-300">
                        {location ? `${location.latitude.toFixed(6)}, ${location.longitude.toFixed(6)}` : t('please_wait_gps')}
                    </p>
                </div>
            </div>

            {/* Description */}
            <div className="space-y-2">
                <label className="text-sm font-medium text-slate-700 dark:text-slate-300 ml-1">{t('brief_description')}</label>
                <textarea
                    className="w-full p-4 rounded-2xl bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 focus:ring-2 focus:ring-indigo-500/50 focus:outline-none text-slate-900 dark:text-white resize-none h-32"
                    placeholder={t('description_placeholder')}
                    value={description}
                    onChange={(e) => setDescription(e.target.value)}
                />
            </div>

            <Button fullWidth onClick={handleSubmit} disabled={photos.length === 0 || description.length < 5 || analyzing}>
                {analyzing ? <span className="animate-spin mr-2">⟳</span> : null}
                {analyzing ? t('submitting') : t('submit_report')}
            </Button>
        </div>
    );
};

const ParkingView: React.FC<{ walletBalance: number, setWalletBalance: (b: number) => void }> = ({ walletBalance, setWalletBalance }) => {
    const { t } = useTranslation();
    const [zones, setZones] = useState<ParkingZone[]>([]);
    const [selectedZone, setSelectedZone] = useState<ParkingZone | null>(null);
    const [hours, setHours] = useState(1);
    const [plate, setPlate] = useState('');
    const [loading, setLoading] = useState(false);

    useEffect(() => {
        getParkingZones().then(data => {
            setZones(data);
            setSelectedZone(data[0]);
        });
    }, []);

    const handlePay = async () => {
        if (!selectedZone || !plate) return alert(t('error_enter_plate'));
        const totalCost = selectedZone.rate * hours;
        if (walletBalance < totalCost) return alert(t('error_insufficient_funds'));

        setLoading(true);
        try {
            // Get the authenticated user's ID from Supabase
            const { data: { user } } = await supabase.auth.getUser();
            if (!user) {
                alert('Please log in to pay for parking');
                setLoading(false);
                return;
            }

            await payForParking({
                user_id: user.id, // Use authenticated user's ID
                zone_id: selectedZone.id,
                duration: hours,
                plate_number: plate,
                amount: totalCost
            });

            setWalletBalance(walletBalance - totalCost);
            alert(t('payment_successful'));
            setPlate('');
            const updated = await getParkingZones();
            setZones(updated);
        } catch (e) {
            alert('Payment failed: ' + e);
        } finally {
            setLoading(false);
        }
    };

    const totalCost = selectedZone ? selectedZone.rate * hours : 0;

    return (
        <div className="space-y-6 pb-20">
            <h2 className="text-2xl font-bold text-slate-900 dark:text-white">{t('pay_for_parking')}</h2>

            {/* Horizontal Scrolling Zone Cards */}
            <div className="overflow-x-auto -mx-4 px-4 no-scrollbar">
                <div className="flex gap-4 pb-2">
                    {zones.map(zone => {
                        const isSelected = selectedZone?.id === zone.id;
                        const totalCapacity = zone.capacity || 0;
                        const occupiedSpots = zone.occupied || 0;
                        const availableSpots = totalCapacity - occupiedSpots;
                        const isAvailable = availableSpots > 0;

                        return (
                            <button
                                key={zone.id}
                                onClick={() => setSelectedZone(zone)}
                                className={`relative flex-shrink-0 w-40 h-36 rounded-3xl p-4 flex flex-col justify-between transition-all ${isSelected
                                    ? 'bg-gradient-to-br from-indigo-600 to-purple-700 text-white shadow-lg shadow-indigo-600/30 scale-105'
                                    : 'bg-slate-800 dark:bg-slate-800 text-white hover:scale-105'
                                    }`}
                            >
                                {/* Availability Indicator */}
                                <div className="absolute top-3 right-3">
                                    <div className={`w-2.5 h-2.5 rounded-full ${isAvailable ? 'bg-green-400' : 'bg-red-400'}`} />
                                </div>

                                <div>
                                    <h3 className="text-xl font-bold">{zone.name}</h3>
                                    <p className={`text-xs mt-0.5 ${isSelected ? 'text-indigo-100' : 'text-slate-400'}`}>MKD/hr</p>
                                </div>

                                <div className="space-y-1">
                                    <p className="text-2xl font-bold">{zone.rate}</p>
                                    <p className={`text-[10px] ${isSelected ? 'text-indigo-100' : 'text-slate-400'}`}>
                                        {availableSpots}/{totalCapacity} {t('free')}
                                    </p>
                                </div>
                            </button>
                        );
                    })}
                </div>
            </div>

            {/* License Plate Input */}
            <div className="space-y-2">
                <div className="relative">
                    <div className="absolute left-4 top-1/2 -translate-y-1/2 flex items-center gap-2">
                        <div className="w-10 h-6 bg-blue-600 rounded flex items-center justify-center">
                            <span className="text-white text-[10px] font-bold">NMK</span>
                        </div>
                    </div>
                    <input
                        type="text"
                        placeholder="SK-1234-AB"
                        value={plate}
                        onChange={(e) => setPlate(e.target.value.toUpperCase())}
                        className="w-full h-14 pl-16 pr-4 rounded-2xl bg-slate-100 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 focus:ring-2 focus:ring-indigo-500/50 focus:outline-none text-slate-900 dark:text-white text-lg font-semibold uppercase tracking-wider"
                    />
                </div>
            </div>

            {/* Duration Selector */}
            <Card className="p-6">
                <div className="flex items-center justify-between mb-4">
                    <span className="text-lg font-semibold text-slate-900 dark:text-white">{t('duration')}</span>
                    <span className="text-3xl font-bold text-slate-900 dark:text-white">{hours} hrs</span>
                </div>
                <div className="flex gap-4">
                    <button
                        onClick={() => setHours(Math.max(1, hours - 1))}
                        className="flex-1 h-14 bg-slate-100 dark:bg-slate-800 hover:bg-slate-200 dark:hover:bg-slate-700 rounded-2xl flex items-center justify-center text-2xl font-bold text-slate-900 dark:text-white transition-colors"
                    >
                        -
                    </button>
                    <button
                        onClick={() => setHours(Math.min(24, hours + 1))}
                        className="flex-1 h-14 bg-slate-100 dark:bg-slate-800 hover:bg-slate-200 dark:hover:bg-slate-700 rounded-2xl flex items-center justify-center text-2xl font-bold text-slate-900 dark:text-white transition-colors"
                    >
                        +
                    </button>
                </div>
            </Card>

            {/* Cost Summary */}
            {selectedZone && (
                <Card className="p-6 bg-slate-50 dark:bg-slate-800/50">
                    <div className="flex items-center justify-between mb-2">
                        <span className="text-sm text-slate-600 dark:text-slate-400">{t('zone')}</span>
                        <span className="text-sm font-semibold text-slate-900 dark:text-white">{selectedZone.name}</span>
                    </div>
                    <div className="flex items-center justify-between mb-4">
                        <span className="text-sm text-slate-600 dark:text-slate-400">{t('rate')}</span>
                        <span className="text-sm font-semibold text-slate-900 dark:text-white">{selectedZone.rate} MKD</span>
                    </div>
                    <div className="h-px bg-slate-200 dark:bg-slate-700 mb-4" />
                    <div className="flex items-center justify-between">
                        <span className="text-lg font-semibold text-slate-900 dark:text-white">{t('total_cost')}</span>
                        <span className="text-3xl font-bold text-indigo-600 dark:text-indigo-400">{totalCost} <span className="text-lg font-normal">MKD</span></span>
                    </div>
                </Card>
            )}

            {/* Pay Button */}
            <Button fullWidth onClick={handlePay} disabled={loading || !selectedZone || !plate} className="h-14 text-lg">
                {loading ? <span className="animate-spin mr-2">⟳</span> : null}
                {t('pay_for_parking')}
            </Button>
        </div>
    );
};

const EventsView: React.FC = () => {
    const { t, language } = useTranslation();
    const [events, setEvents] = useState<any[]>([]);
    const [loading, setLoading] = useState(true);
    const [error, setError] = useState<string | null>(null);
    const [selectedDate, setSelectedDate] = useState<Date>(new Date());

    useEffect(() => {
        const fetchEvents = async () => {
            try {
                setLoading(true);
                const data = await getEvents();
                setEvents(data || []);
                setError(null);
            } catch (err) {
                console.error('Failed to fetch events:', err);
                setError('Failed to load events');
                setEvents([]);
            } finally {
                setLoading(false);
            }
        };
        fetchEvents();
    }, []);

    if (loading) {
        return (
            <div className="h-full flex items-center justify-center">
                <div className="text-center">
                    <div className="w-12 h-12 border-4 border-indigo-600 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
                    <p className="text-slate-500">{t('loading')}</p>
                </div>
            </div>
        );
    }

    if (error) {
        return (
            <div className="h-full flex items-center justify-center p-6">
                <div className="text-center">
                    <Icon path={Icons.alertCircle} size={48} className="text-red-500 mx-auto mb-4" />
                    <p className="text-slate-500">{error}</p>
                </div>
            </div>
        );
    }

    // Simple calendar generation logic
    const getDaysInMonth = (date: Date) => {
        const year = date.getFullYear();
        const month = date.getMonth();
        const days = new Date(year, month + 1, 0).getDate();
        const firstDay = new Date(year, month, 1).getDay();
        return { days, firstDay };
    };

    const { days, firstDay } = getDaysInMonth(selectedDate);
    const dayList = Array.from({ length: days }, (_, i) => i + 1);
    const padding = Array.from({ length: firstDay }, (_, i) => null);

    const getEventForDay = (day: number) => {
        const dateStr = `${selectedDate.getFullYear()}-${String(selectedDate.getMonth() + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const event = events.find(e => {
            // Extract date portion from timestamp (e.g., "2025-12-01 02:12:51..." -> "2025-12-01")
            const eventDate = e.date ? e.date.split('T')[0].split(' ')[0] : '';
            return eventDate === dateStr;
        });
        if (event) {
            const titleKey = `title_${language}` as 'title_en' | 'title_mk' | 'title_sq';
            return {
                type: event.is_holiday ? 'holiday' : 'event',
                title: event[titleKey] || event.title_en || event.title
            };
        }
        return null;
    };

    const selectedEvent = getEventForDay(selectedDate.getDate());

    return (
        <div className="space-y-6">
            <h2 className="text-2xl font-bold text-slate-900 dark:text-white">{t('events')}</h2>

            <Card className="p-6">
                <div className="flex justify-between items-center mb-6">
                    <button onClick={() => setSelectedDate(new Date(selectedDate.getFullYear(), selectedDate.getMonth() - 1, 1))}>
                        <Icon path={Icons.chevronLeft} />
                    </button>
                    <span className="font-bold text-lg">{t(`month_${selectedDate.getMonth()}`)} {selectedDate.getFullYear()}</span>
                    <button onClick={() => setSelectedDate(new Date(selectedDate.getFullYear(), selectedDate.getMonth() + 1, 1))}>
                        <Icon path={Icons.chevronRight} />
                    </button>
                </div>

                <div className="grid grid-cols-7 gap-2 text-center mb-2">
                    {[0, 1, 2, 3, 4, 5, 6].map(d => <span key={d} className="text-xs text-slate-400 font-medium">{t(`day_${d}`)}</span>)}
                </div>

                <div className="grid grid-cols-7 gap-2">
                    {padding.map((_, i) => <div key={`pad-${i}`} />)}
                    {dayList.map(day => {
                        const evt = getEventForDay(day);
                        const isSelected = selectedDate.getDate() === day;
                        return (
                            <button
                                key={day}
                                onClick={() => setSelectedDate(new Date(selectedDate.getFullYear(), selectedDate.getMonth(), day))}
                                className={`aspect-square rounded-xl flex flex-col items-center justify-center relative transition-all ${isSelected ? 'bg-indigo-600 text-white shadow-md' : 'hover:bg-slate-100 dark:hover:bg-slate-800 text-slate-700 dark:text-slate-300'}`}
                            >
                                <span className="text-sm font-medium">{day}</span>
                                {evt && (
                                    <div className={`w-1.5 h-1.5 rounded-full mt-1 ${evt.type === 'holiday' ? 'bg-rose-500' : 'bg-indigo-400'} ${isSelected ? 'bg-white' : ''}`} />
                                )}
                            </button>
                        )
                    })}
                </div>
            </Card>

            {/* Selected Day Detail */}
            <div className="bg-white dark:bg-slate-900 p-6 rounded-3xl border border-slate-200 dark:border-slate-800 min-h-[120px] flex items-center justify-center text-center">
                {selectedEvent ? (
                    <div>
                        <div className={`inline-block px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wider mb-2 ${selectedEvent.type === 'holiday' ? 'bg-rose-100 text-rose-600 dark:bg-rose-900/30' : 'bg-indigo-100 text-indigo-600 dark:bg-indigo-900/30'}`}>
                            {selectedEvent.type === 'holiday' ? t('national_holiday') : t('municipality_event')}
                        </div>
                        <h3 className="text-xl font-bold text-slate-900 dark:text-white">{selectedEvent.title}</h3>
                    </div>
                ) : (
                    <p className="text-slate-400">{t('no_events_today')}</p>
                )}
            </div>
        </div>
    );
};

const NewsView: React.FC = () => {
    const { t } = useTranslation();
    const [news, setNews] = useState<NewsItem[]>([]);
    const [loading, setLoading] = useState(true);
    const [selectedNews, setSelectedNews] = useState<NewsItem | null>(null);
    const [currentPhotoIndex, setCurrentPhotoIndex] = useState(0);

    useEffect(() => {
        getNews().then(data => {
            setNews(data);
            setLoading(false);
        }).catch(err => {
            console.error('Failed to fetch news:', err);
            setLoading(false);
        });
    }, []);

    const formatDate = (dateString: string) => {
        try {
            const date = new Date(dateString);
            if (isNaN(date.getTime())) return 'N/A';
            return date.toLocaleDateString();
        } catch {
            return 'N/A';
        }
    };

    if (loading) {
        return (
            <div className="h-full flex items-center justify-center">
                <p className="text-slate-500">{t('loading')}</p>
            </div>
        );
    }

    return (
        <>
            <div className="space-y-4 pb-20">
                <h2 className="text-2xl font-bold text-slate-900 dark:text-white">{t('news')}</h2>
                {news.length === 0 ? (
                    <p className="text-slate-500 text-center py-10">No news available</p>
                ) : (
                    news.map(item => (
                        <Card
                            key={item.id}
                            className="p-5 flex flex-col gap-3 cursor-pointer hover:shadow-lg transition-shadow"
                            onClick={() => {
                                setSelectedNews(item);
                                setCurrentPhotoIndex(0);
                            }}
                        >
                            {/* Photo thumbnail */}
                            {item.photo_urls && item.photo_urls.length > 0 && (
                                <div className="relative w-full h-48 -mx-5 -mt-5 mb-3">
                                    <img
                                        src={item.photo_urls[0]}
                                        alt={item.title}
                                        className="w-full h-full object-cover rounded-t-2xl"
                                    />
                                    {item.photo_urls.length > 1 && (
                                        <div className="absolute bottom-2 right-2 bg-black/70 text-white px-2 py-1 rounded-md text-xs">
                                            +{item.photo_urls.length - 1} more
                                        </div>
                                    )}
                                </div>
                            )}

                            <div className="flex justify-between items-start">
                                <span className={`px-2 py-1 rounded-md text-xs font-bold uppercase ${item.type === NewsType.CONSTRUCTION ? 'bg-orange-100 dark:bg-orange-900/30 text-orange-700 dark:text-orange-400' : 'bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-400'}`}>
                                    {item.type}
                                </span>
                                <span className="text-xs text-slate-400">{formatDate(item.start_date)}</span>
                            </div>
                            <h3 className="font-bold text-lg text-slate-900 dark:text-white">{item.title}</h3>
                            <p className="text-sm text-slate-500 dark:text-slate-400 line-clamp-2">{item.description}</p>
                        </Card>
                    ))
                )}
            </div>

            {/* Full-screen News Viewer Modal */}
            {selectedNews && (
                <div className="fixed inset-0 bg-black/90 z-50 flex flex-col">
                    {/* Header */}
                    <div className="flex items-center justify-between p-4 text-white">
                        <span className="text-sm">{formatDate(selectedNews.start_date)}</span>
                        <button
                            onClick={() => setSelectedNews(null)}
                            className="p-2 hover:bg-white/10 rounded-full transition-colors"
                        >
                            <Icon path={Icons.close} size={24} />
                        </button>
                    </div>

                    {/* Photo Carousel */}
                    {selectedNews.photo_urls && selectedNews.photo_urls.length > 0 && (
                        <div className="relative flex-1 flex items-center justify-center">
                            <img
                                src={selectedNews.photo_urls[currentPhotoIndex]}
                                alt={selectedNews.title}
                                className="max-w-full max-h-full object-contain"
                            />

                            {selectedNews.photo_urls.length > 1 && (
                                <>
                                    <button
                                        onClick={(e) => {
                                            e.stopPropagation();
                                            setCurrentPhotoIndex((prev) =>
                                                prev > 0 ? prev - 1 : selectedNews.photo_urls!.length - 1
                                            );
                                        }}
                                        className="absolute left-4 top-1/2 -translate-y-1/2 bg-white/20 backdrop-blur-sm p-3 rounded-full hover:bg-white/30 transition-colors"
                                    >
                                        <Icon path={Icons.chevronLeft} size={24} className="text-white" />
                                    </button>
                                    <button
                                        onClick={(e) => {
                                            e.stopPropagation();
                                            setCurrentPhotoIndex((prev) =>
                                                prev < selectedNews.photo_urls!.length - 1 ? prev + 1 : 0
                                            );
                                        }}
                                        className="absolute right-4 top-1/2 -translate-y-1/2 bg-white/20 backdrop-blur-sm p-3 rounded-full hover:bg-white/30 transition-colors"
                                    >
                                        <Icon path={Icons.chevronRight} size={24} className="text-white" />
                                    </button>
                                    <div className="absolute bottom-4 left-1/2 -translate-x-1/2 flex gap-2">
                                        {selectedNews.photo_urls.map((_, idx) => (
                                            <div
                                                key={idx}
                                                className={`w-2 h-2 rounded-full transition-all ${idx === currentPhotoIndex
                                                    ? 'bg-white w-6'
                                                    : 'bg-white/50'
                                                    }`}
                                            />
                                        ))}
                                    </div>
                                </>
                            )}
                        </div>
                    )}

                    {/* Content */}
                    <div className="bg-white dark:bg-slate-900 p-6 rounded-t-3xl max-h-1/3 overflow-y-auto">
                        <div className="flex items-center gap-2 mb-3">
                            <span className={`px-2 py-1 rounded-md text-xs font-bold uppercase ${selectedNews.type === NewsType.CONSTRUCTION ? 'bg-orange-100 dark:bg-orange-900/30 text-orange-700 dark:text-orange-400' : 'bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-400'}`}>
                                {selectedNews.type}
                            </span>
                        </div>
                        <h2 className="text-xl font-bold text-slate-900 dark:text-white mb-3">{selectedNews.title}</h2>
                        <p className="text-slate-600 dark:text-slate-400 leading-relaxed">{selectedNews.description}</p>
                    </div>
                </div>
            )}
        </>
    );
};

const WalletView: React.FC<{ balance: number, setBalance: (b: number) => void }> = ({ balance, setBalance }) => {
    const { t } = useTranslation();
    return (
        <div className="space-y-6">
            <div className="relative h-48 rounded-3xl bg-gradient-to-br from-indigo-600 to-purple-700 p-8 text-white shadow-xl shadow-indigo-600/20 overflow-hidden">
                <div className="absolute top-0 right-0 p-8 opacity-10">
                    <Icon path={Icons.wallet} size={120} />
                </div>
                <div className="relative z-10 flex flex-col justify-between h-full">
                    <div>
                        <p className="text-indigo-200 font-medium mb-1">{t('current_balance')}</p>
                        <h1 className="text-4xl font-bold">{balance} <span className="text-2xl font-normal opacity-80">MKD</span></h1>
                    </div>
                    <div className="flex justify-between items-end">
                        <div className="text-indigo-200 text-xs">
                            <p>{t('valid_thru')}</p>
                            <p className="font-mono text-white text-base">12/28</p>
                        </div>
                        <Icon path={Icons.building} className="text-white/50" size={32} />
                    </div>
                </div>
            </div>

            <h3 className="font-bold text-lg text-slate-900 dark:text-white">{t('add_funds')}</h3>
            <div className="grid grid-cols-3 gap-3">
                {[200, 500, 1000].map(amt => (
                    <Button key={amt} variant="secondary" onClick={() => setBalance(balance + amt)} className="h-16 flex-col gap-0">
                        <span className="font-bold text-lg">+{amt}</span>
                        <span className="text-[10px] uppercase">MKD</span>
                    </Button>
                ))}
            </div>
        </div>
    );
};

const PlaceholderView: React.FC<{ title: string, icon: string }> = ({ title, icon }) => {
    const { t } = useTranslation();
    return (
        <div className="h-full flex flex-col items-center justify-center text-center opacity-50">
            <Icon path={icon} size={64} className="mb-4 text-slate-300" />
            <h2 className="text-xl font-bold text-slate-900 dark:text-white">{title}</h2>
            <p>{t('content_coming_soon')}</p>
        </div>
    );
};

const HistoryView: React.FC = () => {
    const { t } = useTranslation();
    const [reports, setReports] = useState<Report[]>([]);

    useEffect(() => {
        const stored = localStorage.getItem('submittedReports');
        if (stored) setReports(JSON.parse(stored));
    }, []);

    return (
        <div className="space-y-4">
            <h2 className="text-2xl font-bold text-slate-900 dark:text-white">{t('report_history')}</h2>
            {reports.length === 0 ? (
                <p className="text-slate-500 text-center py-10">{t('no_reports_yet')}</p>
            ) : (
                reports.map(r => (
                    <Card key={r.id} className="flex gap-4 p-4">
                        <div className="w-16 h-16 rounded-xl bg-slate-100 dark:bg-slate-800 overflow-hidden flex-shrink-0">
                            {r.photoPreviewUrl && <img src={r.photoPreviewUrl} className="w-full h-full object-cover" />}
                        </div>
                        <div>
                            <h4 className="font-bold text-slate-900 dark:text-white">{r.title}</h4>
                            <p className="text-xs text-slate-500 mb-1">{new Date(r.timestamp).toLocaleDateString()}</p>
                            <span className="px-2 py-0.5 bg-indigo-50 dark:bg-indigo-900/30 text-indigo-600 text-xs rounded-md font-medium">{t(r.category)}</span>
                        </div>
                    </Card>
                ))
            )}
        </div>
    );
};

const MenuHub: React.FC<{ onViewChange: (v: string) => void, theme: 'light' | 'dark', setTheme: (t: 'light' | 'dark') => void, language: string, setLanguage: (l: any) => void }> = ({ onViewChange, theme, setTheme, language, setLanguage }) => {
    const { t } = useTranslation();

    return (
        <div className="space-y-6">
            <h2 className="text-2xl font-bold text-slate-900 dark:text-white">{t('settings')}</h2>

            <Card className="divide-y divide-slate-100 dark:divide-slate-800 p-0 overflow-hidden">
                <div className="p-4 flex items-center justify-between">
                    <div className="flex items-center gap-3">
                        <div className="w-8 h-8 rounded-full bg-slate-100 dark:bg-slate-800 flex items-center justify-center">
                            <Icon path={theme === 'light' ? Icons.sun : Icons.moon} size={16} />
                        </div>
                        <span className="font-medium text-slate-700 dark:text-slate-200">{t('appearance')}</span>
                    </div>
                    <button onClick={() => setTheme(theme === 'light' ? 'dark' : 'light')} className="px-3 py-1 bg-slate-100 dark:bg-slate-800 rounded-lg text-sm font-medium">
                        {theme === 'light' ? 'Light' : 'Dark'}
                    </button>
                </div>

                <div className="p-4 flex items-center justify-between">
                    <div className="flex items-center gap-3">
                        <div className="w-8 h-8 rounded-full bg-slate-100 dark:bg-slate-800 flex items-center justify-center">
                            <span className="text-xs font-bold">AZ</span>
                        </div>
                        <span className="font-medium text-slate-700 dark:text-slate-200">{t('language')}</span>
                    </div>
                    <div className="flex gap-1">
                        {['en', 'mk', 'sq'].map(l => (
                            <button
                                key={l}
                                onClick={() => setLanguage(l)}
                                className={`w-8 h-8 rounded-lg text-xs font-bold uppercase ${language === l ? 'bg-indigo-600 text-white' : 'bg-slate-100 dark:bg-slate-800 text-slate-500'}`}
                            >
                                {l}
                            </button>
                        ))}
                    </div>
                </div>
            </Card>

            <div className="text-center pt-10">
                <p className="text-xs text-slate-400">E-Kicevo App v2.1.0</p>
            </div>
        </div>
    );
};