import React, { useState, useEffect, useCallback, useRef } from 'react';
import { ReportCategory, GeolocationState, Transaction, ParkingZone, NewsItem, NewsStatus, NewsType, Report, Landmark } from './types';
import { api } from './services/api';
import { useTranslation } from './i18n';
import { Camera, CameraResultType, CameraSource } from '@capacitor/camera';
import { App as CapacitorApp } from '@capacitor/app';
import { supabase } from './supabase';
import { MapContainer, TileLayer, Marker, Popup, useMap } from 'react-leaflet';
import L from 'leaflet';
import { TutorialOverlay } from './components/tutorial';
import { MapView, ReportView, ParkingView, EventsView, NewsView, WalletView, PlaceholderView, HistoryView, MenuHub } from './components/views';

// Destructure for easier usage in component, or just use api.method
const { getParkingZones, payParking: payForParking, getEvents, getNews, getLandmarks } = api;

// --- Icon System ---
const Icon: React.FC<{ path: string; className?: string; size?: number;[key: string]: any; }> = ({ path, className = '', size = 24, ...props }) => (
    <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={1.5} strokeLinecap="round" strokeLinejoin="round" {...props}>
        <path d={path} />
    </svg>
);

const Icons = {
    location: "M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z M12 10a2 2 0 1 0 0-4 2 2 0 0 0 0 4Z",
    camera: "M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z M12 17a4 4 0 1 0 0-8 4 4 0 0 0 0 8z",
    chevronLeft: "m15 18-6-6 6-6",
    chevronRight: "m9 18 6-6-6-6",
    checkCircle: "M22 11.08V12a10 10 0 1 1-5.93-9.14 M9 11l3 3L22 4",
    alertCircle: "m21.73 18-8-14a2 2 0 0 0-3.46 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z M12 9v4 M12 17h.01",
    sun: "M12 1v2 M12 21v2 M4.22 4.22l1.42 1.42 M18.36 18.36l1.42 1.42 M1 12h2 M21 12h2 M4.22 19.78l1.42-1.42 M18.36 5.64l1.42-1.42 M12 18a6 6 0 1 0 0-12 6 6 0 0 0 0 12z",
    moon: "M12 3a6.36 6.36 0 0 0 9 9 9 9 0 1 1-9-9Z",
    building: "M6 22V4a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v18 M6 12H4a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h2 M18 9h2a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2h-2 M10 6h4 M10 10h4 M10 14h4 M10 18h4",
    cog: "M12 20a8 8 0 1 0 0-16 8 8 0 0 0 0 16z M12 14a2 2 0 1 0 0-4 2 2 0 0 0 0 4z M12 2v2 M12 22v-2 m-7.07-2.93 1.41 1.41 m11.31-11.31 1.41 1.41 M2 12h2 M22 12h-2 m-2.93 7.07 1.41-1.41 M6.34 6.34l1.41-1.41",
    phone: "M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z",
    parking: "M9 12h6 M2 9a3 3 0 0 1 0 6v1a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-1a3 3 0 0 1 0-6V8a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2Z",
    calendar: "M8 2v4 M16 2v4 M3 10h18 M3 6h18v14a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2Z",
    wallet: "M21 12V7H5a2 2 0 0 1 0-4h14v4 M3 5v14a2 2 0 0 0 2 2h16v-5 M18 12a2 2 0 0 0 0 4h4v-4Z",
    calendarDays: "M8 2v4 M16 2v4 M3 10h18 M3 6h18v14a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2Z M8 14h.01 M12 14h.01 M16 14h.01 M8 18h.01 M12 18h.01 M16 18h.01",
    news: "M4 22h16a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2H8a2 2 0 0 0-2 2v16a2 2 0 0 1-2 2Zm0 0a2 2 0 0 1-2-2V8h2 M14 12h4 M14 8h4 M14 16h4 M8 12h2 M8 8h2 M8 16h2",
    report: "M3 11v2a1 1 0 0 0 1 1h3l3 3V8l-3 3H4a1 1 0 0 0-1 1z m8 0.5a4.5 4.5 0 0 1 0-3 m3 1.5a8 8 0 0 1 0-4 m3 2a10 10 0 0 1 0-6",
    wrench: "M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6",
    home: "M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z",
    menu: "M4 6h16M4 12h16M4 18h16",
    plus: "M12 5v14M5 12h14",
    clock: "M12 6v6l4 2",
    creditCard: "M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z",
    map: "M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7",
    history: "M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8M3 3v5h5M12 7v5l4 2",
    x: "M18 6L6 18M6 6l12 12"
};

// --- UI Components ---
const Card: React.FC<{ children: React.ReactNode; className?: string; onClick?: () => void }> = ({ children, className = '', onClick }) => (
    <div onClick={onClick} className={`bg-white dark:bg-slate-900 rounded-3xl shadow-sm border border-slate-100 dark:border-slate-800 overflow-hidden ${className} ${onClick ? 'cursor-pointer active:scale-[0.98] transition-transform' : ''}`}>
        {children}
    </div>
);

const Button: React.FC<{ children: React.ReactNode; onClick?: () => void; variant?: 'primary' | 'secondary' | 'ghost' | 'danger'; className?: string; disabled?: boolean; fullWidth?: boolean }> = ({ children, onClick, variant = 'primary', className = '', disabled = false, fullWidth = false }) => {
    const baseStyle = "relative h-12 px-6 rounded-2xl font-semibold transition-all duration-200 flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed";
    const variants = {
        primary: "bg-indigo-600 hover:bg-indigo-700 text-white shadow-lg shadow-indigo-600/20 active:translate-y-0.5",
        secondary: "bg-slate-100 dark:bg-slate-800 text-slate-900 dark:text-white hover:bg-slate-200 dark:hover:bg-slate-700",
        ghost: "bg-transparent hover:bg-slate-100 dark:hover:bg-slate-800 text-slate-600 dark:text-slate-300",
        danger: "bg-red-50 text-red-600 hover:bg-red-100 dark:bg-red-900/20 dark:text-red-400"
    };
    return (
        <button onClick={onClick} disabled={disabled} className={`${baseStyle} ${variants[variant]} ${fullWidth ? 'w-full' : ''} ${className}`}>
            {children}
        </button>
    );
};

const Input: React.FC<React.InputHTMLAttributes<HTMLInputElement>> = ({ className, ...props }) => (
    <input className={`w-full h-12 px-4 rounded-2xl bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 focus:outline-none focus:ring-2 focus:ring-indigo-500/50 transition-all text-slate-900 dark:text-white placeholder:text-slate-400 ${className}`} {...props} />
);

const Select: React.FC<React.SelectHTMLAttributes<HTMLSelectElement>> = ({ className, children, ...props }) => (
    <div className="relative">
        <select className={`w-full h-12 px-4 pr-10 rounded-2xl bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 focus:outline-none focus:ring-2 focus:ring-indigo-500/50 transition-all appearance-none text-slate-900 dark:text-white ${className}`} {...props}>
            {children}
        </select>
        <Icon path={Icons.chevronRight} className="absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none rotate-90" size={20} />
    </div>
);

// --- App Component ---
export const App: React.FC = () => {
    const { t, language, setLanguage } = useTranslation();
    const [activeView, setActiveView] = useState(() => localStorage.getItem('lastActiveView') || 'dashboard');
    const [theme, setTheme] = useState<'light' | 'dark'>('light');

    // Lifted photos state for camera restoration
    const [photos, setPhotos] = useState<string[]>(() => {
        const stored = localStorage.getItem('reportPhotos');
        return stored ? JSON.parse(stored) : [];
    });

    useEffect(() => {
        localStorage.setItem('reportPhotos', JSON.stringify(photos));
    }, [photos]);

    useEffect(() => {
        localStorage.setItem('lastActiveView', activeView);
    }, [activeView]);
    const [isVerified, setIsVerified] = useState(false);
    const [phoneNumber, setPhoneNumber] = useState('');
    const [verificationCode, setVerificationCode] = useState('');
    const [showVerificationInput, setShowVerificationInput] = useState(false);
    const [walletBalance, setWalletBalance] = useState(1250);

    // Initialize theme with system preference
    useEffect(() => {
        const savedTheme = localStorage.getItem('theme') as 'light' | 'dark' | null;
        if (savedTheme) {
            setTheme(savedTheme);
        } else {
            // Detect system theme
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            setTheme(prefersDark ? 'dark' : 'light');
        }
    }, []);

    // Apply theme changes
    useEffect(() => {
        if (theme === 'dark') {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
        localStorage.setItem('theme', theme);
    }, [theme]);

    // Check verification
    useEffect(() => {
        const verified = localStorage.getItem('isVerified') === 'true';
        if (verified) setIsVerified(true);
    }, []);

    // Handle Android back button and App Restoration (Camera)
    useEffect(() => {
        let backButtonListener: any;
        let restoreListener: any;

        const setupListeners = async () => {
            backButtonListener = await CapacitorApp.addListener('backButton', ({ canGoBack }) => {
                if (activeView !== 'dashboard') {
                    setActiveView('dashboard');
                } else if (canGoBack) {
                    window.history.back();
                } else {
                    CapacitorApp.exitApp();
                }
            });

            // Handle camera result when app is restored after being killed
            restoreListener = await CapacitorApp.addListener('appRestoredResult', (data: any) => {
                if (data.pluginId === 'Camera' && data.methodName === 'getPhoto' && data.success) {
                    const imagePath = data.data.webPath;
                    if (imagePath) {
                        // Fetch and save the restored photo
                        fetch(imagePath)
                            .then(res => res.blob())
                            .then(blob => {
                                const reader = new FileReader();
                                reader.onloadend = () => {
                                    if (typeof reader.result === 'string') {
                                        // Update state directly
                                        setPhotos(prev => [...prev, reader.result as string]);
                                        // Navigate to report view to show the photo
                                        setActiveView('report');
                                    }
                                };
                                reader.readAsDataURL(blob);
                            })
                            .catch(err => console.error('Error recovering photo:', err));
                    }
                }
            });
        };

        setupListeners();

        return () => {
            if (backButtonListener) backButtonListener.remove();
            if (restoreListener) restoreListener.remove();
        };
    }, [activeView]);

    const handleVerify = async () => {
        try {
            // Format phone number the same way as when sending the code
            const formattedPhone = phoneNumber.startsWith('+') ? phoneNumber : `+389${phoneNumber}`;

            const { data, error } = await supabase.auth.verifyOtp({
                phone: formattedPhone,
                token: verificationCode,
                type: 'sms'
            });

            if (error) {
                alert(t('error_code_mismatch'));
                console.error('Verification error:', error);
            } else {
                localStorage.setItem('isVerified', 'true');
                setIsVerified(true);
            }
        } catch (err) {
            alert(t('error_code_mismatch'));
            console.error('Verification error:', err);
        }
    };

    const renderContent = () => {
        switch (activeView) {
            case 'dashboard': return <HomeView onViewChange={setActiveView} walletBalance={walletBalance} />;
            case 'report': return <ReportView onViewChange={setActiveView} photos={photos} setPhotos={setPhotos} />;
            case 'parking': return <ParkingView walletBalance={walletBalance} setWalletBalance={setWalletBalance} />;
            case 'events': return <EventsView />;
            case 'news': return <NewsView />;
            case 'wallet': return <WalletView balance={walletBalance} setBalance={setWalletBalance} />;
            case 'map': return <MapView />;
            case 'history': return <HistoryView />;
            case 'menu': return <MenuHub onViewChange={setActiveView} theme={theme} setTheme={setTheme} language={language} setLanguage={setLanguage} />;
            default: return <HomeView onViewChange={setActiveView} walletBalance={walletBalance} />;
        }
    };

    const handleSendCode = async () => {
        if (phoneNumber.length < 8) {
            alert(t('error_phone_invalid'));
            return;
        }

        try {
            // Format phone number with country code (assuming Macedonia +389)
            const formattedPhone = phoneNumber.startsWith('+') ? phoneNumber : `+389${phoneNumber}`;

            const { data, error } = await supabase.auth.signInWithOtp({
                phone: formattedPhone
            });

            if (error) {
                alert(`Error: ${error.message}`);
                console.error('Send OTP error:', error);
            } else {
                setShowVerificationInput(true);
                alert(t('code_sent'));
            }
        } catch (err) {
            alert(`Error sending code: ${err}`);
            console.error('Send OTP error:', err);
        }
    };

    if (!isVerified) {
        return (
            <div className="min-h-screen flex items-center justify-center p-6 bg-slate-50 dark:bg-slate-950">
                <Card className="w-full max-w-sm p-8 text-center">
                    <div className="w-16 h-16 bg-indigo-100 dark:bg-indigo-900/30 rounded-full flex items-center justify-center mx-auto mb-6">
                        <Icon path={Icons.phone} className="text-indigo-600" size={32} />
                    </div>
                    <h1 className="text-2xl font-bold text-slate-900 dark:text-white mb-2">{t('verify_account')}</h1>
                    <p className="text-slate-500 mb-8">{t('verification_description')}</p>

                    {!showVerificationInput ? (
                        <div className="space-y-4">
                            <Input
                                type="tel"
                                placeholder={t('phone_placeholder')}
                                value={phoneNumber}
                                onChange={(e) => setPhoneNumber(e.target.value)}
                            />
                            <Button fullWidth onClick={handleSendCode}>
                                {t('send_code')}
                            </Button>
                        </div>
                    ) : (
                        <div className="space-y-4">
                            <p className="text-sm text-slate-500">{t('enter_code_prompt')} <span className="font-semibold text-slate-900 dark:text-white">{phoneNumber}</span></p>
                            <Input
                                type="text"
                                placeholder="123456"
                                value={verificationCode}
                                onChange={(e) => setVerificationCode(e.target.value)}
                                className="text-center tracking-widest text-xl font-mono"
                            />
                            <Button fullWidth onClick={handleVerify}>{t('verify')}</Button>
                            <Button variant="ghost" fullWidth onClick={() => setShowVerificationInput(false)}>{t('change_number')}</Button>
                        </div>
                    )}
                </Card>
            </div>
        );
    }

    return (
        <div className="relative min-h-screen bg-slate-50 dark:bg-slate-950 max-w-md mx-auto shadow-2xl overflow-hidden">
            {/* Header with Safe Area Support */}
            <div
                className="absolute top-0 left-0 right-0 px-6 flex items-center justify-between z-20 bg-white/80 dark:bg-slate-900/80 backdrop-blur-md border-b border-slate-200/50 dark:border-slate-800/50"
                style={{ paddingTop: 'max(16px, env(safe-area-inset-top))', height: 'calc(64px + env(safe-area-inset-top))' }}
            >
                <div className="flex items-center gap-2" onClick={() => setActiveView('dashboard')}>
                    <div className="w-8 h-8 bg-indigo-600 rounded-lg flex items-center justify-center">
                        <Icon path={Icons.building} className="text-white" size={18} />
                    </div>
                    <span className="font-bold text-lg text-slate-900 dark:text-white tracking-tight">{t('app_title')}</span>
                </div>
                <div className="flex items-center gap-3">
                    <button onClick={() => setActiveView('wallet')} className="flex items-center gap-2 px-3 py-1.5 bg-slate-100 dark:bg-slate-800 rounded-full">
                        <Icon path={Icons.wallet} size={14} className="text-indigo-600" />
                        <span className="text-sm font-semibold text-slate-700 dark:text-slate-200">{walletBalance}</span>
                    </button>
                </div>
            </div>

            {/* Scrollable Content with Padding for Header and Nav */}
            <main
                className="absolute left-0 right-0 overflow-y-auto no-scrollbar p-4"
                style={{
                    top: 'calc(64px + env(safe-area-inset-top))',
                    bottom: 'calc(80px + env(safe-area-inset-bottom))'
                }}
            >
                <div className="animate-fade-in">
                    {renderContent()}
                </div>
            </main>

            {/* Bottom Navigation with Safe Area Support */}
            <div
                className="absolute bottom-0 left-0 right-0 bg-white/90 dark:bg-slate-900/90 backdrop-blur-xl border-t border-slate-200 dark:border-slate-800 px-6 flex items-center justify-between z-30"
                style={{
                    paddingBottom: 'env(safe-area-inset-bottom)',
                    height: 'calc(80px + env(safe-area-inset-bottom))'
                }}
            >
                <NavButton icon={Icons.home} label="Home" active={activeView === 'dashboard'} onClick={() => setActiveView('dashboard')} />
                <NavButton icon={Icons.parking} label="Parking" active={activeView === 'parking'} onClick={() => setActiveView('parking')} />

                {/* FAB */}
                <div className="-mt-8">
                    <button
                        onClick={() => setActiveView('report')}
                        className="w-14 h-14 bg-indigo-600 rounded-full shadow-lg shadow-indigo-600/30 flex items-center justify-center text-white active:scale-95 transition-transform"
                    >
                        <Icon path={Icons.plus} size={28} />
                    </button>
                </div>

                <NavButton icon={Icons.wallet} label="Wallet" active={activeView === 'wallet'} onClick={() => setActiveView('wallet')} />
                <NavButton icon={Icons.menu} label="Menu" active={activeView === 'menu'} onClick={() => setActiveView('menu')} />
            </div>
        </div>
    );
};

const NavButton: React.FC<{ icon: string; label: string; active: boolean; onClick: () => void }> = ({ icon, label, active, onClick }) => (
    <button onClick={onClick} className={`flex flex-col items-center gap-1 ${active ? 'text-indigo-600' : 'text-slate-400 hover:text-slate-600 dark:hover:text-slate-300'}`}>
        <Icon path={icon} size={24} strokeWidth={active ? 2.5 : 1.5} />
        {/* <span className="text-[10px] font-medium">{label}</span> */}
    </button>
);

// --- Sub-Views ---


const HomeView: React.FC<{ onViewChange: (view: string) => void, walletBalance: number }> = ({ onViewChange, walletBalance }) => {
    const { t } = useTranslation();
    const hour = new Date().getHours();
    const greeting = hour < 12 ? t('good_morning') : hour < 18 ? t('good_afternoon') : t('good_evening');

    return (
        <div className="space-y-6">
            {/* Greeting */}
            <div>
                <h2 className="text-3xl font-bold text-slate-900 dark:text-white">{greeting}, Citizen</h2>
                <p className="text-slate-500">{t('how_can_we_help')}</p>
            </div>

            {/* Quick Actions Grid */}
            <div className="grid grid-cols-2 gap-4">
                <ServiceCard id="home-service-report" icon={Icons.report} title={t('report_new_issue')} color="bg-rose-500" onClick={() => onViewChange('report')} />
                <ServiceCard id="home-service-parking" icon={Icons.parking} title={t('parking')} color="bg-indigo-500" onClick={() => onViewChange('parking')} />
                <ServiceCard icon={Icons.calendarDays} title={t('events')} color="bg-orange-500" onClick={() => onViewChange('events')} />
                <ServiceCard id="home-service-news" icon={Icons.news} title={t('news')} color="bg-emerald-500" onClick={() => onViewChange('news')} />
                <ServiceCard icon={Icons.map} title={t('map_view')} color="bg-cyan-500" onClick={() => onViewChange('map')} />
                <ServiceCard icon={Icons.history} title={t('report_history')} color="bg-slate-500" onClick={() => onViewChange('history')} />
            </div>

            {/* Mini Wallet Widget */}
            <Card id="home-service-wallet" className="p-5 bg-gradient-to-br from-indigo-600 to-purple-700 border-none text-white" onClick={() => onViewChange('wallet')}>
                <div className="flex justify-between items-start">
                    <div>
                        <p className="text-indigo-100 text-sm font-medium">{t('current_balance')}</p>
                        <h3 className="text-3xl font-bold mt-1">{walletBalance} <span className="text-lg font-normal opacity-80">MKD</span></h3>
                    </div>
                    <div className="p-2 bg-white/10 rounded-xl backdrop-blur-sm">
                        <Icon path={Icons.wallet} className="text-white" />
                    </div>
                </div>
            </Card>
        </div>
    );
};

const ServiceCard: React.FC<{ icon: string; title: string; color: string; onClick: () => void; id?: string }> = ({ icon, title, color, onClick, id }) => (
    <button id={id} onClick={onClick} className="bg-white dark:bg-slate-900 p-4 rounded-3xl shadow-sm border border-slate-100 dark:border-slate-800 flex flex-col items-start gap-3 hover:scale-[1.02] active:scale-[0.98] transition-all text-left group">
        <div className={`w-10 h-10 ${color} rounded-2xl flex items-center justify-center text-white shadow-md`}>
            <Icon path={icon} size={20} />
        </div>
        <span className="font-semibold text-slate-900 dark:text-white text-sm leading-tight group-hover:text-indigo-600 dark:group-hover:text-indigo-400 transition-colors">{title}</span>
    </button>
);








